{% extends "admin/base.html" %}

{% block title %}{{ form_title }}{% endblock %}
{% block page_title %}{{ form_title }}{% endblock %}

{% block header_actions %}
<a href="/admin/products" class="btn btn-outline">‚Üê –ù–∞–∑–∞–¥ –∫ —Å–ø–∏—Å–∫—É</a>
{% endblock %}

{% block content %}
<div class="form-page">
  <form method="post" action="{{ form_action }}" enctype="multipart/form-data" class="product-form">
    <div class="form-grid">
      <!-- –õ–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ -->
      <div class="form-column">
        <div class="form-card">
          <h3>–û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h3>
          
          <div class="form-group">
            <label for="name">–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞ <span class="required">*</span></label>
            <input 
              type="text" 
              id="name" 
              name="name" 
              required 
              value="{{ product.name if product else '' }}"
              placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ó–∏–º–Ω–∏–µ –∫–æ–∂–∞–Ω—ã–µ —Å–∞–ø–æ–≥–∏"
            >
          </div>
          
          <div class="form-row">
            <div class="form-group">
              <label for="category_id">–ö–∞—Ç–µ–≥–æ—Ä–∏—è <span class="required">*</span></label>
              <select id="category_id" name="category_id" required onchange="loadSubcategories(this.value, 'subcategory_id', '{{ product.subcategory_id if product else '' }}')">
                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é</option>
                {% for cat in categories %}
                <option 
                  value="{{ cat.id }}" 
                  {% if product and product.subcategory and product.subcategory.category_id == cat.id %}selected{% endif %}
                >
                  {{ cat.icon }} {{ cat.name }}
                </option>
                {% endfor %}
              </select>
            </div>
            
            <div class="form-group">
              <label for="subcategory_id">–ü–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏—è <span class="required">*</span></label>
              <select id="subcategory_id" name="subcategory_id" required>
                <option value="">–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é</option>
                {% if product and product.subcategory %}
                  {% for cat in categories if product.subcategory.category_id == cat.id %}
                    {% for subcat in cat.subcategories %}
                    <option value="{{ subcat.id }}" {% if product.subcategory_id == subcat.id %}selected{% endif %}>
                      {{ subcat.name }}
                    </option>
                    {% endfor %}
                  {% endfor %}
                {% endif %}
              </select>
            </div>
          </div>
          
          <div class="form-group">
            <label for="description">–û–ø–∏—Å–∞–Ω–∏–µ</label>
            <textarea 
              id="description" 
              name="description" 
              rows="4"
              placeholder="–ü–æ–¥—Ä–æ–±–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞"
            >{{ product.description if product and product.description else '' }}</textarea>
          </div>
        </div>
        
        <div class="form-card">
          <h3>–¶–µ–Ω–∞</h3>
          
          <div class="form-row">
            <div class="form-group">
              <label for="price">–¶–µ–Ω–∞ (‚ÇΩ) <span class="required">*</span></label>
              <input 
                type="number" 
                id="price" 
                name="price" 
                required 
                min="0" 
                step="1"
                value="{{ product.price | int if product else '' }}"
                placeholder="0"
              >
            </div>
            
            <div class="form-group">
              <label for="old_price">–°—Ç–∞—Ä–∞—è —Ü–µ–Ω–∞ (‚ÇΩ)</label>
              <input 
                type="number" 
                id="old_price" 
                name="old_price" 
                min="0" 
                step="1"
                value="{{ product.old_price | int if product and product.old_price else '' }}"
                placeholder="–ï—Å–ª–∏ –µ—Å—Ç—å —Å–∫–∏–¥–∫–∞"
              >
              <small class="form-hint">–ï—Å–ª–∏ —É–∫–∞–∑–∞–Ω–∞ –∏ –±–æ–ª—å—à–µ —Ç–µ–∫—É—â–µ–π ‚Äî —Ç–æ–≤–∞—Ä –ø–æ–ø–∞–¥—ë—Ç –≤ ¬´–°–∫–∏–¥–∫–∏¬ª</small>
            </div>
          </div>
        </div>
        
        <div class="form-card">
          <h3>–•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏</h3>
          
          <div class="form-group">
            <label>–†–∞–∑–º–µ—Ä—ã</label>
            <div class="sizes-grid">
              {% set current_sizes = [] %}
              {% if product and product.sizes_json %}
                {% set current_sizes = product.sizes_json | from_json %}
              {% endif %}
              {% for size in range(34, 43) %}
              <label class="size-checkbox">
                <input 
                  type="checkbox" 
                  name="sizes" 
                  value="{{ size }}"
                  {% if size in current_sizes %}checked{% endif %}
                >
                <span>{{ size }}</span>
              </label>
              {% endfor %}
            </div>
          </div>
          
          <div class="form-group">
            <label for="color">–¶–≤–µ—Ç</label>
            <input 
              type="text" 
              id="color" 
              name="color" 
              value="{{ product.color if product and product.color else '' }}"
              placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ß—ë—Ä–Ω—ã–π, –ö–æ—Ä–∏—á–Ω–µ–≤—ã–π"
            >
          </div>
        </div>
      </div>
      
      <!-- –ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞ -->
      <div class="form-column">
        <div class="form-card">
          <h3>–§–æ—Ç–æ–≥—Ä–∞—Ñ–∏—è</h3>
          
          {% if has_image %}
          <div class="current-image">
            <img src="{{ product.image_url }}" alt="{{ product.name }}">
            <p class="image-hint">–¢–µ–∫—É—â–µ–µ —Ñ–æ—Ç–æ. –ó–∞–≥—Ä—É–∑–∏—Ç–µ –Ω–æ–≤–æ–µ, —á—Ç–æ–±—ã –∑–∞–º–µ–Ω–∏—Ç—å.</p>
          </div>
          {% elif product and product.image_url %}
          <div class="missing-image">
            <span class="missing-icon">‚ö†Ô∏è</span>
            <p>–§–∞–π–ª –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω: <code>{{ product.image_url }}</code></p>
            <p class="image-hint">–ó–∞–≥—Ä—É–∑–∏—Ç–µ –Ω–æ–≤–æ–µ —Ñ–æ—Ç–æ.</p>
          </div>
          {% endif %}
          
          <div class="form-group">
            <label for="image">{% if has_image %}–ó–∞–º–µ–Ω–∏—Ç—å —Ñ–æ—Ç–æ{% else %}–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ{% endif %}</label>
            <input 
              type="file" 
              id="image" 
              name="image" 
              accept="image/jpeg,image/png,image/webp"
            >
            <small class="form-hint">JPG, PNG –∏–ª–∏ WebP. –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π —Ä–∞–∑–º–µ—Ä: 800√ó800 px</small>
          </div>
        </div>
        
        <div class="form-card">
          <h3>–û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ</h3>
          
          <div class="form-group">
            <label class="checkbox-label">
              <input 
                type="checkbox" 
                name="is_new" 
                value="true"
                {% if product and product.is_new %}checked{% endif %}
              >
              <span class="checkmark"></span>
              <span>–ù–æ–≤–∏–Ω–∫–∞</span>
            </label>
            <small class="form-hint">–¢–æ–≤–∞—Ä –ø–æ—è–≤–∏—Ç—Å—è –≤ —Ä–∞–∑–¥–µ–ª–µ ¬´–ù–æ–≤–∏–Ω–∫–∏¬ª</small>
          </div>
          
          <div class="form-group">
            <label class="checkbox-label">
              <input 
                type="checkbox" 
                name="is_featured" 
                value="true"
                {% if product and product.is_featured %}checked{% endif %}
              >
              <span class="checkmark"></span>
              <span>–ê–∫—Ç—É–∞–ª—å–Ω—ã–π —Ç–æ–≤–∞—Ä</span>
            </label>
            <small class="form-hint">–¢–æ–≤–∞—Ä –ø–æ—è–≤–∏—Ç—Å—è –Ω–∞ –≥–ª–∞–≤–Ω–æ–π –≤ ¬´–ê–∫—Ç—É–∞–ª—å–Ω—ã–µ –º–æ–¥–µ–ª–∏¬ª</small>
          </div>
          
          <div class="form-group">
            <label class="checkbox-label">
              <input 
                type="checkbox" 
                name="is_active" 
                value="true"
                {% if not product or product.is_active %}checked{% endif %}
              >
              <span class="checkmark"></span>
              <span>–ê–∫—Ç–∏–≤–µ–Ω (–æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –Ω–∞ —Å–∞–π—Ç–µ)</span>
            </label>
          </div>
        </div>
        
        <div class="form-actions">
          <button type="submit" class="btn btn-primary btn-lg">
            {% if product %}üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è{% else %}‚ûï –î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä{% endif %}
          </button>
          <a href="/admin/products" class="btn btn-outline">–û—Ç–º–µ–Ω–∞</a>
        </div>
      </div>
    </div>
  </form>
</div>
{% endblock %}

{% block scripts %}
<script>
  // –ü—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –∑–∞–≥—Ä—É–∂–∞–µ–º –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –µ—Å–ª–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏—è —É–∂–µ –≤—ã–±—Ä–∞–Ω–∞
  document.addEventListener('DOMContentLoaded', function() {
    const categorySelect = document.getElementById('category_id');
    if (categorySelect && categorySelect.value) {
      loadSubcategories(
        categorySelect.value, 
        'subcategory_id', 
        '{{ product.subcategory_id if product else "" }}'
      );
    }
  });
</script>
{% endblock %}

