{% extends "admin/base.html" %}

{% block title %}–¢–æ–≤–∞—Ä—ã{% endblock %}
{% block page_title %}–¢–æ–≤–∞—Ä—ã{% endblock %}

{% block header_actions %}
<a href="/admin/products/add" class="btn btn-primary">‚ûï –î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä</a>
{% endblock %}

{% block content %}
<div class="products-page">
  <!-- –§–∏–ª—å—Ç—Ä—ã -->
  <div class="filters-bar">
    <form method="get" action="/admin/products" class="filters-form">
      <div class="filter-group">
        <label for="category_id">–ö–∞—Ç–µ–≥–æ—Ä–∏—è:</label>
        <select name="category_id" id="category_id">
          <option value="">–í—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</option>
          {% for cat in categories %}
          <option value="{{ cat.id }}" {% if selected_category_id == cat.id %}selected{% endif %}>
            {{ cat.icon }} {{ cat.name }}
          </option>
          {% endfor %}
        </select>
      </div>
      
      {% if selected_category_id %}
      <div class="filter-group">
        <label for="subcategory_id">–ü–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏—è:</label>
        <select name="subcategory_id" id="subcategory_id">
          <option value="">–í—Å–µ –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–∏</option>
          {% for cat in categories if cat.id == selected_category_id %}
            {% for subcat in cat.subcategories %}
            <option value="{{ subcat.id }}" {% if selected_subcategory_id == subcat.id %}selected{% endif %}>
              {{ subcat.name }}
            </option>
            {% endfor %}
          {% endfor %}
        </select>
      </div>
      {% endif %}
      
      <div class="filter-group search-group">
        <input type="text" name="search" placeholder="–ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é..." value="{{ search }}">
        <button type="submit" class="btn btn-secondary">üîç</button>
      </div>
      
      <div class="filter-group">
        <label class="checkbox-inline">
          <input type="checkbox" name="show_deleted" value="1" {% if show_deleted %}checked{% endif %}>
          –ü–æ–∫–∞–∑–∞—Ç—å —É–¥–∞–ª—ë–Ω–Ω—ã–µ
        </label>
      </div>
      
      {% if search or selected_category_id or show_deleted %}
      <a href="/admin/products" class="btn btn-outline">–°–±—Ä–æ—Å–∏—Ç—å</a>
      {% endif %}
    </form>
  </div>

  <!-- –¢–∞–±–ª–∏—Ü–∞ —Ç–æ–≤–∞—Ä–æ–≤ -->
  <div id="products-table-wrapper">
    {% include "admin/_products_table.html" %}
  </div>
</div>

<script>
  (function () {
    const form = document.querySelector('.filters-form');
    if (!form) return;

    const searchInput = form.querySelector('input[name="search"]');
    const categorySelect = form.querySelector('select[name="category_id"]');
    const subcategorySelect = form.querySelector('select[name="subcategory_id"]');
    const showDeletedCheckbox = form.querySelector('input[name="show_deleted"]');
    const tableWrapper = document.getElementById('products-table-wrapper');

    if (!tableWrapper) return;

    let debounceTimer = null;
    const DEBOUNCE_MS = 300;

    function getParams() {
      const params = new URLSearchParams();
      const categoryId = categorySelect && categorySelect.value ? categorySelect.value : '';
      const subcategoryId = subcategorySelect && subcategorySelect.value ? subcategorySelect.value : '';
      const search = searchInput && searchInput.value ? searchInput.value : '';
      const showDeleted = showDeletedCheckbox && showDeletedCheckbox.checked ? '1' : '';

      if (categoryId) params.set('category_id', categoryId);
      if (subcategoryId) params.set('subcategory_id', subcategoryId);
      if (search) params.set('search', search);
      if (showDeleted) params.set('show_deleted', showDeleted);

      return params;
    }

    async function loadProducts() {
      const params = getParams();
      const url = '/admin/products/partial?' + params.toString();

      try {
        const response = await fetch(url, {
          headers: { 'X-Requested-With': 'XMLHttpRequest' }
        });
        if (!response.ok) {
          console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–æ–≤–∞—Ä–æ–≤', response.status);
          return;
        }
        const html = await response.text();
        tableWrapper.innerHTML = html;
      } catch (err) {
        console.error('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ç–æ–≤–∞—Ä–æ–≤', err);
      }
    }

    function debounceLoad() {
      if (debounceTimer) clearTimeout(debounceTimer);
      debounceTimer = setTimeout(loadProducts, DEBOUNCE_MS);
    }

    form.addEventListener('submit', function (e) {
      e.preventDefault();
      loadProducts();
    });

    if (searchInput) {
      searchInput.addEventListener('input', debounceLoad);
    }

    if (categorySelect) {
      categorySelect.addEventListener('change', function () {
        loadProducts();
      });
    }

    if (subcategorySelect) {
      subcategorySelect.addEventListener('change', function () {
        loadProducts();
      });
    }

    if (showDeletedCheckbox) {
      showDeletedCheckbox.addEventListener('change', function () {
        loadProducts();
      });
    }
  })();
</script>
{% endblock %}
